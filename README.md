````md
# ASE School Backend (NestJS + PostgreSQL + Redis + Firebase + R2)

Production-ready backend for **ASE School App** with:
- **Auth**: SchoolCode + Email + Password, **Email OTP** (Forgot/Reset password)
- **Roles**: PRINCIPAL, TEACHER, STUDENT (+ ASE_ADMIN reserved)
- **DB**: PostgreSQL (TypeORM migrations)
- **Cache**: Redis
- **Push**: Firebase Admin (FCM)
- **Files**: Cloudflare R2 (S3 compatible) with presigned upload URLs
- **Swagger**: API docs

---

## 1) Requirements

Install:
- **Node.js** (v20+ recommended)
- **PostgreSQL** (local)
- **Redis** (local)
- Optional:
  - Firebase service account JSON for push notifications
  - Cloudflare R2 credentials for file uploads
  - SMTP credentials for Email OTP

---

## 2) Setup (Backend)

### 2.) Clone & Install
```bash
git clone <your-repo-url>
cd ase-school-backend
npm install
````

### 2.2) Create `.env`

Copy `.env.example` to `.env`:

```bash
cp .env.example .env
```

Update `.env` with your local values.

âœ… Example `.env` (minimum for local dev):

```env
NODE_ENV=development
PORT=3000
APP_NAME=ASE School Backend
APP_URL=http://localhost:3000
SWAGGER_PATH=api/docs

# JWT
JWT_ACCESS_SECRET=CHANGE_ME_access_secret_very_long
JWT_REFRESH_SECRET=CHANGE_ME_refresh_secret_very_long
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=30d

# bcrypt
BCRYPT_SALT_ROUNDS=12

# Database
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_USER=postgres
DB_PASSWORD=postgres
DB_PASS=postgres
DB_NAME=ase_school
DB_SYNCHRONIZE=false
DB_LOGGING=false

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_TLS=false

# Firebase (Optional for push)
FIREBASE_SERVICE_ACCOUNT_PATH=./secrets/firebase-service-account.json
FIREBASE_SERVICE_ACCOUNT_JSON=

# R2 (Optional for file uploads)
R2_ACCOUNT_ID=CHANGE_ME
R2_ACCESS_KEY_ID=CHANGE_ME
R2_SECRET_ACCESS_KEY=CHANGE_ME
R2_BUCKET=ase-school
R2_PUBLIC_BASE_URL=https://YOUR_PUBLIC_R2_DOMAIN_OR_CDN
R2_ENDPOINT=https://<ACCOUNT_ID>.r2.cloudflarestorage.com
R2_REGION=auto

# Email (OTP)
MAIL_FROM_NAME=ASE School
MAIL_FROM_EMAIL=your_real_smtp_email@yourdomain.com
SMTP_HOST=smtp.hostinger.com
SMTP_PORT=587
SMTP_USER=your_real_smtp_email@yourdomain.com
SMTP_PASS=your_smtp_password
SMTP_SECURE=false

OTP_LENGTH=6
OTP_TTL_SECONDS=300
OTP_MAX_ATTEMPTS=5
OTP_COOLDOWN_SECONDS=60

LOG_LEVEL=info
```

> âš ï¸ Important: `MAIL_FROM_EMAIL` must be a real mailbox you own in your SMTP provider.
> OTP is generated by backend, NOT by SMTP provider.

---

## 3) Start PostgreSQL + Create DB

Create database:

```sql
CREATE DATABASE ase_school;
```

(You can use pgAdmin or psql.)

---

## 4) Start Redis

If installed locally, run:

```bash
redis-server
```

---

## 5) Run Migrations + Seed

### 5.1) Run migrations

```bash
npm run migration:run
```

### 5.2) Seed dev data

```bash
npm run seed:dev
```

âœ… Seed creates demo school + principal:

* **School Code**: `ASE001`
* **Principal Email**: `principal@ase001.com`
* **Password**: `Temp@1234`

---

## 6) Run Backend Server

```bash
npm run start:dev
```

API base:

* `http://localhost:3000/api`

Swagger:

* `http://localhost:3000/api/docs`

---

## 7) Testing Flow (Swagger / Thunder Client)

### 7.1) Authentication (Principal)

#### A) Login

`POST /api/auth/login`

```json
{
  "schoolCode": "ASE001",
  "email": "principal@ase001.com",
  "password": "Temp@1234",
  "deviceId": "windows-dev-1"
}
```

âœ… Response includes:

* `accessToken`
* `refreshToken`
* `mustChangePassword`

> Use `Authorization: Bearer <accessToken>` for all secured APIs.

---

### 7.2) Get Current User

`GET /api/users/me`

Header:

```
Authorization: Bearer <accessToken>
```

---

### 7.3) Forgot Password (OTP)

#### A) Request OTP

`POST /api/auth/forgot-password`

```json
{
  "schoolCode": "ASE001",
  "email": "principal@ase001.com"
}
```

Backend generates OTP and sends via email using SMTP.

#### B) Verify OTP

`POST /api/auth/verify-otp`

```json
{
  "schoolCode": "ASE001",
  "email": "principal@ase001.com",
  "otp": "123456"
}
```

#### C) Reset Password

`POST /api/auth/reset-password`

```json
{
  "schoolCode": "ASE001",
  "email": "principal@ase001.com",
  "otp": "123456",
  "newPassword": "NewPass@1234",
  "confirmNewPassword": "NewPass@1234"
}
```

âœ… Then login again using new password.

---

## 8) Teacher Module Testing (Principal)

### 8.1) Create Teacher

`POST /api/teachers`

```json
{
  "teacherId": "T001",
  "fullName": "Aman Teacher",
  "gender": "MALE",
  "phone": "9999999999",
  "email": "teacher1@ase001.com",
  "profilePhotoUrl": null,
  "dob": "1995-02-10",
  "classTeacherClass": 8,
  "classTeacherSection": "B",
  "subjects": ["Math", "Science"],
  "temporaryPassword": "Temp@1234"
}
```

âœ… This creates:

* user (role TEACHER)
* teacher_profile

### 8.2) List Teachers

`GET /api/teachers`

### 8.3) Get by ID

`GET /api/teachers/{teacherProfileId}`

### 8.4) Update

`PATCH /api/teachers/{teacherProfileId}`

### 8.5) Delete

`DELETE /api/teachers/{teacherProfileId}`

---

## 9) Students Module Testing (Principal)

### 9.1) Create Student

Swagger will show exact DTO fields.
Follow **Swagger request schema** strictly (ValidationPipe forbids extra keys).

âœ… After creation:

* user (role STUDENT)
* student_profile

### 9.2) List Students

`GET /api/students`

### 9.3) Get / Update / Delete

Use Swagger endpoints.

> If you get `"property xyz should not exist"` it means you sent a field not allowed in DTO.

---

## 10) Timetables Module Testing (Principal)

### 10.1) Teacher Timetable (Upsert)

`POST /api/timetables/teacher`

```json
{
  "teacherUserId": "PASTE_TEACHER_USER_UUID_HERE",
  "slots": [
    { "dayOfWeek": 1, "timing": "09:00-09:40", "subject": "Math", "classNumber": 8, "section": "B", "sortOrder": 1 }
  ]
}
```

### 10.2) Student Timetable (Upsert)

`POST /api/timetables/student`

```json
{
  "classNumber": 8,
  "section": "B",
  "slots": [
    { "dayOfWeek": 1, "timing": "09:00-09:40", "subject": "Math", "sortOrder": 1 },
    { "dayOfWeek": 1, "timing": "09:40-10:20", "subject": "English", "sortOrder": 2 }
  ]
}
```

### 10.3) Get Student Timetable by path

`GET /api/timetables/student/8/B`

If section is null timetable:
`GET /api/timetables/student/8`

### 10.4) My Timetable (later in app)

Teacher:
`GET /api/timetables/teacher/my`
Student:
`GET /api/timetables/student/me`

---

## 11) Circulars Module Testing (Principal)

### 11.1) Create Circular

`POST /api/circulars`

```json
{
  "type": "GENERAL",
  "title": "Holiday Notice",
  "description": "School will remain closed tomorrow.",
  "images": []
}
```

> For listing circulars, `type` is usually required as query param:
> Example:
> `GET /api/circulars?type=GENERAL`

### 11.2) Get One

`GET /api/circulars/{id}`

### 11.3) Update

`PATCH /api/circulars/{id}`

### 11.4) Delete

`DELETE /api/circulars/{id}`

Teacher/Student circular testing will be done later via app login flows.

---

## 12) Notifications Module Testing

### 12.1) List Notifications

`GET /api/notifications`

If empty, it means:

* no circular was created OR
* no notifications inserted for your user role
  (Usually notifications are created when circulars are created, for teachers/students.)

### 12.2) Mark Read

`POST /api/notifications/mark-read`

Mark one:

```json
{
  "notificationId": "PASTE_UUID_HERE"
}
```

Mark all:

```json
{
  "all": true
}
```

---

## 13) Files Upload (R2) Testing (Optional)

### 13.1) Get presigned URL

`POST /api/files/presigned-url`

```json
{
  "folder": "circulars",
  "filename": "notice.jpg",
  "contentType": "image/jpeg",
  "sizeBytes": 12345,
  "kind": "IMAGE"
}
```

Response:

* `uploadUrl` (PUT this with raw bytes)
* `publicUrl`
* `key`

### 13.2) Upload file (client side)

Use PUT to `uploadUrl` with body = file bytes.

### 13.3) Finalize upload

`POST /api/files/finalize`

```json
{
  "key": "schools/<schoolId>/circulars/....jpg",
  "url": "https://....publicUrl...."
}
```

---

# Frontend Integration Guide (Flutter)

## 1) Base URL

```dart
const baseUrl = "http://localhost:3000/api";
```

For real device testing:

* Use your PC IP like `http://192.168.x.x:3000/api`
* Ensure firewall allows port `3000`

## 2) Auth Headers

Store `accessToken` after login.
Attach to all requests:

```
Authorization: Bearer <accessToken>
```

## 3) Login Flow (Principal/Teacher/Student)

* POST `/auth/login`
* Save tokens
* If `mustChangePassword == true`, show reset password flow

## 4) Forgot Password Flow

* POST `/auth/forgot-password`
* POST `/auth/verify-otp`
* POST `/auth/reset-password`

## 5) Teacher App

Principal:

* Manage teachers
* Create circulars
* Create timetables
* View notifications feed

Teacher:

* View timetable
* Mark attendance (later in real app)
* View circulars
* View notifications

## 6) Parent/Student App

Student:

* View timetable
* View circulars
* View notifications
* Attendance view (later)

---

# Common Issues

## 1) 304 on GET /api

304 is caching (ETag). It is **not** a Redis problem.
Your API is running fine.

## 2) Validation errors: "property xyz should not exist"

Backend uses:

* `whitelist: true`
* `forbidNonWhitelisted: true`

So frontend must send **only allowed DTO fields**.

## 3) OTP Email not delivered

* Ensure `MAIL_FROM_EMAIL` is a real mailbox in SMTP provider
* Ensure domain has valid DNS if using custom email
* For testing, you can use Gmail SMTP or an existing mailbox you own

---

# Current Backend Status (Testing)

âœ… Done and tested:

* Auth login
* users/me
* forgot-password + verify-otp + reset-password
* Teachers: create + list + get + update + delete
* Students: create + list + basic checks
* Timetables: upsert + get by path for student/teacher (principal)
* Circulars: principal create/list/get/update/delete (principal side)

ðŸ”œ Remaining to test fully (best inside real apps):

* Attendance flows (teacher marking + parent/student viewing)
* Notifications in real lifecycle (created by circulars and read by users)
* Teacher/Student circular consumption (seen/unseen)
* Push notifications end-to-end (requires Firebase device tokens + real devices)

---

## Quick Checklist (For New Developer)

1. `npm install`
2. Create `.env` from `.env.example`
3. Start PostgreSQL + create DB
4. Start Redis
5. `npm run migration:run`
6. `npm run seed:dev`
7. `npm run start:dev`
8. Open Swagger: `http://localhost:3000/api/docs`
9. Login with demo principal
10. Create teacher, student, timetables, circulars

---

## Demo Credentials

* SchoolCode: `ASE001`
* Email: `principal@ase001.com`
* Password: `Temp@1234`
* DeviceId: `windows-dev-1`

---

```
```
